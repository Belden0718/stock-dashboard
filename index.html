<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè‚¡ç¥¨æç›Šç®¡ç† (é€²éšç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .stat-card { text-align: center; padding: 20px; }
        .text-up { color: #dc3545; font-weight: bold; }
        .text-down { color: #198754; font-weight: bold; }
        .loading { opacity: 0.6; pointer-events: none; }
        .price-source { font-size: 0.75rem; color: #6c757d; display: block;}
        .update-status { font-size: 0.85rem; color: #6c757d; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>ğŸ“ˆ å€‹äººè‚¡ç¥¨æŠ•è³‡çœ‹æ¿ <small class="text-muted fs-6">(é€²éšç‰ˆ)</small></h2>
            <span class="update-status" id="autoUpdateStatus">è‡ªå‹•æ›´æ–°ä¸­...</span>
        </div>
        <button id="btnUpdatePrice" class="btn btn-primary" onclick="forceUpdatePrices()">
            ğŸ”„ å¼·åˆ¶æ›´æ–°ç¾åƒ¹
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">ç¸½å¸‚å€¼</h5>
                <h3 id="totalMarketValue">0</h3>
                <small class="text-muted">ç¾åœ¨æŒè‚¡åƒ¹å€¼</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">ç¸½æŠ•å…¥æˆæœ¬</h5>
                <h3 id="totalCost">0</h3>
                <small class="text-muted">å·²æŠ•å…¥è³‡é‡‘</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">æœªå¯¦ç¾æç›Š</h5>
                <h3 id="totalUnrealizedPL">0</h3>
                <small id="totalUnrealizedRate">0%</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">å·²å¯¦ç¾+è‚¡åˆ©</h5>
                <h3 id="totalRealizedPL">0</h3>
                <small class="text-muted">è½è¢‹ç‚ºå®‰</small>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">æ–°å¢äº¤æ˜“ç´€éŒ„</div>
        <div class="card-body">
            <form id="tradeForm" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">é¡åˆ¥</label>
                    <select class="form-select" id="type" onchange="toggleInputs()">
                        <option value="buy">è²·å…¥</option>
                        <option value="sell">è³£å‡º</option>
                        <option value="dividend">ç¾é‡‘è‚¡åˆ©</option>
                        <option value="discount">æŠ˜è®“/é€€è²»</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" class="form-control" id="symbol" placeholder="ä¾‹: 2330" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">äº¤æ˜“æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="tradeDate" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label" id="lblQty">è‚¡æ•¸</label>
                    <input type="number" class="form-control" id="qty">
                </div>
                <div class="col-md-2">
                    <label class="form-label" id="lblPrice">æˆäº¤å–®åƒ¹</label>
                    <input type="number" class="form-control" id="price" step="0.01">
                </div>
                <div class="col-md-2">
                    <label class="form-label" id="lblFee">æ‰‹çºŒè²» (è‡ªå‹•è¨ˆç®—)</label>
                    <input type="number" class="form-control" id="fee" readonly style="background-color: #f0f0f0;">
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success">æ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“Š ç›®å‰æŒå€‰</div>
        <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨</th>
                        <th>è‚¡æ•¸</th>
                        <th>å‡åƒ¹</th>
                        <th>ç¾åƒ¹ <small>(è‡ªå‹•æŠ“å–)</small></th>
                        <th>å¸‚å€¼</th>
                        <th>æœªå¯¦ç¾æç›Š</th>
                        <th>æœªå¯¦ç¾æç›Šç‡ %</th>
                        <th>è‚¡åˆ©</th>
                        <th>æœªå¯¦ç¾æç›Š+è‚¡åˆ©</th>
                    </tr>
                </thead>
                <tbody id="holdingsTable"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“ æ­·å²ç´€éŒ„</div>
        <div class="card-body table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>é¡åˆ¥</th>
                        <th>è‚¡ç¥¨</th>
                        <th>æ˜ç´°</th>
                        <th>æç›Š/æ”¶æ”¯</th>
                        <th>æ‰‹çºŒè²»</th>
                        <th>åˆªé™¤</th>
                    </tr>
                </thead>
                <tbody id="historyTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let transactions = [];
    let priceCache = {};
    const PRICE_UPDATE_INTERVAL = 30000;

    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('tradeDate').valueAsDate = new Date();

    // æ ¼å¼åŒ–å‡½æ•¸
    const fmtMoney = (n) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits:0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('zh-TW').format(n);
    const fmtRound = (n) => Math.round(n); // å››æ¨äº”å…¥å»é™¤å°æ•¸

    // è¨ˆç®—æ‰‹çºŒè²»
    function calculateFee(amount) {
        let fee = Math.round(amount * 0.001425);
        return Math.max(fee, 20);
    }

    // ç›£è½åƒ¹æ ¼å’Œè‚¡æ•¸è®ŠåŒ–
    document.getElementById('price').addEventListener('change', updateFeeDisplay);
    document.getElementById('qty').addEventListener('change', updateFeeDisplay);
    document.getElementById('type').addEventListener('change', updateFeeDisplay);

    function updateFeeDisplay() {
        const type = document.getElementById('type').value;
        if (type === 'buy' || type === 'sell') {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const qty = parseFloat(document.getElementById('qty').value) || 0;
            const amount = price * qty;
            const fee = calculateFee(amount);
            document.getElementById('fee').value = fee;
        } else {
            document.getElementById('fee').value = 0;
        }
    }

    function toggleInputs() {
        const type = document.getElementById('type').value;
        const priceInput = document.getElementById('price');
        const qtyInput = document.getElementById('qty');
        const feeInput = document.getElementById('fee');
        const lblPrice = document.getElementById('lblPrice');
        const lblQty = document.getElementById('lblQty');
        const lblFee = document.getElementById('lblFee');
        const symbolInput = document.getElementById('symbol');

        if (type === 'dividend' || type === 'discount') {
            qtyInput.disabled = true;
            qtyInput.value = 1;
            symbolInput.disabled = type === 'discount';
            symbolInput.required = type !== 'discount';
            lblPrice.innerText = type === 'dividend' ? "è‚¡åˆ©é‡‘é¡" : "æŠ˜è®“é‡‘é¡";
            lblQty.innerText = "ä»½æ•¸(å›ºå®š1)";
            priceInput.placeholder = "ç¸½é‡‘é¡";
            feeInput.value = 0;
            lblFee.innerText = "æ‰‹çºŒè²» (ç„¡)";
            feeInput.disabled = true;
        } else {
            qtyInput.disabled = false;
            symbolInput.disabled = false;
            symbolInput.required = true;
            lblPrice.innerText = "æˆäº¤å–®åƒ¹";
            lblQty.innerText = "è‚¡æ•¸";
            priceInput.placeholder = "";
            lblFee.innerText = "æ‰‹çºŒè²» (è‡ªå‹•è¨ˆç®—)";
            feeInput.disabled = true;
            updateFeeDisplay();
        }
    }

    document.getElementById('tradeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.getElementById('type').value;
        const symbol = document.getElementById('symbol').value.toUpperCase().trim();
        const tradeDate = document.getElementById('tradeDate').value;
        let price = parseFloat(document.getElementById('price').value) || 0;
        let qty = parseFloat(document.getElementById('qty').value) || 0;
        let fee = parseFloat(document.getElementById('fee').value) || 0;

        if (!tradeDate || !price) {
            alert('è«‹å¡«å…¥äº¤æ˜“æ—¥æœŸå’Œé‡‘é¡');
            return;
        }

        if ((type === 'buy' || type === 'sell') && !symbol) {
            alert('è«‹å¡«å…¥è‚¡ç¥¨ä»£è™Ÿ');
            return;
        }

        transactions.push({ 
            id: Date.now(), 
            date: tradeDate,
            time: new Date().toLocaleString(),
            type, 
            symbol, 
            price, 
            qty, 
            fee 
        });
        
        saveData();
        render();
        this.reset();
        document.getElementById('type').value = 'buy';
        document.getElementById('tradeDate').valueAsDate = new Date();
        toggleInputs();
    });

    function deleteTrade(id) {
        if(confirm('åˆªé™¤æ­¤ç­†ï¼Ÿ')) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            render();
        }
    }

    function saveData() {
        localStorage.setItem('stockTransactions', JSON.stringify(transactions));
        localStorage.setItem('stockPriceCache', JSON.stringify(priceCache));
    }

    function loadData() {
        transactions = JSON.parse(localStorage.getItem('stockTransactions')) || [];
        priceCache = JSON.parse(localStorage.getItem('stockPriceCache')) || {};
    }

    function calculateHoldings() {
        let holdings = {};
        let totalRealized = 0;
        let totalDividends = 0;
        let symbolDividends = {};
        
        [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            if (!holdings[t.symbol]) holdings[t.symbol] = { qty: 0, cost: 0 };
            if (!symbolDividends[t.symbol]) symbolDividends[t.symbol] = 0;
            
            let h = holdings[t.symbol];
            
            if (t.type === 'buy') {
                h.qty += t.qty;
                h.cost += (t.price * t.qty) + t.fee;
            } else if (t.type === 'sell') {
                let avg = h.qty > 0 ? h.cost / h.qty : t.price;
                let costPart = avg * t.qty;
                let rev = (t.price * t.qty) - t.fee;
                h.qty -= t.qty;
                h.cost -= costPart;
                totalRealized += (rev - costPart);
            } else if (t.type === 'dividend') {
                symbolDividends[t.symbol] += t.price;
                totalDividends += t.price;
            } else if (t.type === 'discount') {
                symbolDividends[t.symbol] += t.price;
                totalDividends += t.price;
            }
        });
        
        Object.keys(holdings).forEach(k => {
            if (holdings[k].qty < 0.001) delete holdings[k];
        });

        return { holdings, totalRealized, totalDividends, symbolDividends };
    }

    async function autoUpdatePrices() {
        const { holdings } = calculateHoldings();
        const symbols = Object.keys(holdings);

        if (symbols.length === 0) return;

        let query = symbols.map(s => `tse_${s}.tw|otc_${s}.tw`).join('|');
        const timeStamp = new Date().getTime();
        const targetUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${query}&json=1&delay=0&_=${timeStamp}`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;

        try {
            const res = await fetch(proxyUrl);
            const data = await res.json();

            if (data.msgArray && data.msgArray.length > 0) {
                data.msgArray.forEach(stk => {
                    let sym = stk.c;
                    let price = stk.z;
                    let source = "å³æ™‚";

                    if (price === '-' || !price) {
                        if (stk.o && stk.o !== '-') { price = stk.o; source = "é–‹ç›¤åƒ¹"; }
                        else if (stk.y && stk.y !== '-') { price = stk.y; source = "æ˜¨æ”¶åƒ¹"; }
                        else if (stk.b && stk.b.split('_')[0] !== '-') { price = stk.b.split('_')[0]; source = "è²·é€²åƒ¹"; }
                    }

                    if (sym && price && price !== '-') {
                        priceCache[sym] = { 
                            val: parseFloat(price), 
                            src: source, 
                            time: stk.t || 'æ”¶ç›¤' 
                        };
                    }
                });

                saveData();
                render();
                updateStatusMessage();
            }
        } catch (err) {
            console.error('è‡ªå‹•æ›´æ–°å¤±æ•—:', err);
        }
    }

    function forceUpdatePrices() {
        const btn = document.getElementById('btnUpdatePrice');
        btn.innerHTML = 'â³ è®€å–ä¸­...';
        btn.classList.add('loading');

        autoUpdatePrices().then(() => {
            btn.innerHTML = 'ğŸ”„ å¼·åˆ¶æ›´æ–°ç¾åƒ¹';
            btn.classList.remove('loading');
        });
    }

    function updateStatusMessage() {
        const status = document.getElementById('autoUpdateStatus');
        const now = new Date();
        const time = now.toLocaleTimeString('zh-TW');
        status.innerText = `æœ€å¾Œæ›´æ–°: ${time}`;
    }

    function manualPrice(sym, val) {
        priceCache[sym] = { val: parseFloat(val), src: "æ‰‹å‹•", time: "" };
        saveData();
        render();
    }

    function render() {
        const { holdings, totalRealized, totalDividends, symbolDividends } = calculateHoldings();
        const tbody = document.getElementById('holdingsTable');
        tbody.innerHTML = '';
        
        let gMkt=0, gCost=0, gUnrealized=0;

        for (let s in holdings) {
            let h = holdings[s];
            let avg = h.cost / h.qty;
            
            let pObj = priceCache[s] || { val: avg, src: 'ç„¡è³‡æ–™' };
            let currP = pObj.val;

            let mkt = h.qty * currP;
            let unrl = mkt - h.cost;
            let rate = h.cost ? (unrl/h.cost)*100 : 0;
            let divId = symbolDividends[s] || 0;
            let divPlusUnrl = divId + unrl;
            
            let unrlCls = unrl >= 0 ? 'text-up' : 'text-down';
            let rateCls = rate >= 0 ? 'text-up' : 'text-down';
            let divCls = divId >= 0 ? 'text-up' : 'text-down';
            let divPlusCls = divPlusUnrl >= 0 ? 'text-up' : 'text-down';

            let tr = `
                <tr>
                    <td><strong>${s}</strong></td>
                    <td>${fmtNum(h.qty)}</td>
                    <td>${fmtNum(avg.toFixed(2))}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm d-inline-block" style="width:90px" 
                            value="${currP}" onchange="manualPrice('${s}', this.value)">
                        <span class="price-source">${pObj.src} ${pObj.time||''}</span>
                    </td>
                    <td>${fmtMoney(mkt)}</td>
                    <td class="${unrlCls}">${fmtMoney(fmtRound(unrl))}</td>
                    <td class="${rateCls}">${rate.toFixed(2)}%</td>
                    <td class="${divCls}">${fmtMoney(fmtRound(divId))}</td>
                    <td class="${divPlusCls}">${fmtMoney(fmtRound(divPlusUnrl))}</td>
                </tr>`;
            tbody.innerHTML += tr;
            gMkt+=mkt; gCost+=h.cost; gUnrealized+=unrl;
        }

        const hBody = document.getElementById('historyTable');
        hBody.innerHTML = '';
        [...transactions].reverse().forEach(t => {
            let typeText = t.type === 'buy' ? 'è²·' : (t.type === 'sell' ? 'è³£' : (t.type === 'dividend' ? 'è‚¡åˆ©' : 'æŠ˜è®“'));
            let typeBg = t.type === 'buy' ? 'bg-danger' : (t.type === 'sell' ? 'bg-success' : 'bg-warning text-dark');
            let detail = (t.type === 'dividend' || t.type === 'discount') ? fmtMoney(fmtRound(t.price)) : `${fmtNum(t.price)}/è‚¡ Ã— ${fmtNum(t.qty)}è‚¡`;
            let amount = t.type === 'buy' ? (t.price * t.qty + t.fee) : (t.type === 'sell' ? (t.price * t.qty - t.fee) : t.price);
            
            let tr = `<tr>
                <td><small>${t.date}</small></td>
                <td><span class="badge ${typeBg}">${typeText}</span></td>
                <td>${t.symbol}</td>
                <td><small>${detail}</small></td>
                <td>${t.type === 'buy' ? '-' : '+'}${fmtMoney(fmtRound(Math.abs(amount)))}</td>
                <td>${t.fee > 0 ? fmtMoney(fmtRound(t.fee)) : '-'}</td>
                <td><button class="btn btn-sm btn-outline-danger py-0" onclick="deleteTrade(${t.id})">Ã—</button></td>
             </tr>`;
            hBody.innerHTML += tr;
        });

        document.getElementById('totalMarketValue').innerText = fmtMoney(fmtRound(gMkt));
        document.getElementById('totalMarketValue').className = gMkt >= 0 ? 'text-up' : 'text-down';
        document.getElementById('totalCost').innerText = fmtMoney(fmtRound(gCost));
        document.getElementById('totalCost').className = gCost >= 0 ? 'text-up' : 'text-down';
        document.getElementById('totalUnrealizedPL').innerText = fmtMoney(fmtRound(gUnrealized));
        document.getElementById('totalUnrealizedPL').className = gUnrealized >= 0 ? 'text-up' : 'text-down';
        document.getElementById('totalUnrealizedRate').innerText = (gCost ? (gUnrealized/gCost)*100 : 0).toFixed(2) + '%';
        document.getElementById('totalRealizedPL').innerText = fmtMoney(fmtRound(totalRealized + totalDividends));
        document.getElementById('totalRealizedPL').className = (totalRealized + totalDividends) >= 0 ? 'text-up' : 'text-down';
    }

    // åˆå§‹åŒ–
    loadData();
    render();
    autoUpdatePrices();
    updateStatusMessage();

    // æ¯30ç§’è‡ªå‹•æ›´æ–°ä¸€æ¬¡è‚¡åƒ¹
    setInterval(autoUpdatePrices, PRICE_UPDATE_INTERVAL);
</script>

</body>
</html>
