<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="å€‹äººè‚¡ç¥¨æŠ•è³‡ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´é›¢ç·šä½¿ç”¨">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æŠ•è³‡çœ‹æ¿">
    
    <title>å€‹äººè‚¡ç¥¨æç›Šç®¡ç†</title>
    <!-- æš«æ™‚ç§»é™¤ manifestï¼Œé¿å… PWA è·¯å¾‘å•é¡Œ -->
    <!-- <link rel="manifest" href="/stock-dashboard/manifest.json"> -->
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --success-color: #198754;
            --danger-color: #dc3545;
        }
        
        body { 
            background-color: #f8f9fa; 
            font-family: "Microsoft JhengHei", -apple-system, sans-serif;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .card { 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            border: none; 
            margin-bottom: 1rem;
            border-radius: 12px;
        }
        
        .stat-card { 
            text-align: center; 
            padding: 1rem; 
            height: 100%;
            transition: transform 0.2s;
        }
        
        .stat-card:active {
            transform: scale(0.98);
        }
        
        .text-up { color: var(--danger-color) !important; font-weight: bold !important; }
        .text-down { color: var(--success-color) !important; font-weight: bold !important; }
        .price-source { font-size: 0.7rem; color: #999; display: block; margin-top: 2px;}
        
        .status-bar { 
            font-size: 0.75rem; 
            color: #6c757d; 
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .firebase-status { 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-weight: bold; 
            font-size: 0.7rem;
            white-space: nowrap;
        }
        
        .firebase-connected { background-color: #d1e7dd; color: #0f5132; }
        .firebase-disconnected { background-color: #f8d7da; color: #842029; }
        
        .loading { opacity: 0.7; pointer-events: none; }
        
        /* é ‚éƒ¨æŒ‰éˆ•å€å„ªåŒ– */
        .header-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            width: 100%;
        }
        
        .user-info {
            font-size: 0.8rem;
            color: #6c757d;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .btn-group-actions {
            display: flex;
            gap: 0.5rem;
            width: 100%;
        }
        
        .btn-group-actions .btn {
            flex: 1;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            white-space: nowrap;
        }
        
        /* PWA å®‰è£æç¤ºå·²ç§»é™¤ */
        
        /* å¹³æ¿ä»¥ä¸Šè¨­å‚™ */
        @media (min-width: 768px) {
            .header-actions {
                flex-direction: row;
                align-items: center;
                justify-content: flex-end;
                width: auto;
            }
            
            .user-section {
                width: auto;
                flex-direction: row;
            }
            
            .btn-group-actions {
                width: auto;
            }
            
            .btn-group-actions .btn {
                flex: 0 0 auto;
            }
            
            .user-info {
                flex: 0 0 auto;
            }
        }
        
        /* æ‰‹æ©Ÿå„ªåŒ– */
        @media (max-width: 576px) {
            .container { padding-left: 0.75rem; padding-right: 0.75rem; }
            h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
            .stat-card h3 { font-size: 1.4rem; }
            .stat-card h5 { font-size: 0.85rem; }
            .card-header { font-size: 0.9rem; padding: 0.75rem 1rem; }
            .table { font-size: 0.85rem; }
            
            /* ç¢ºä¿æŒ‰éˆ•å°é½Š */
            .btn-group-actions {
                flex-direction: column;
            }
            
            .btn-group-actions .btn {
                width: 100%;
            }
        }
        
        /* è¡¨æ ¼å„ªåŒ– */
        .table-responsive {
            border-radius: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* å¡ç‰‡å‹•ç•« */
        .card {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<!-- PWA å®‰è£æç¤ºå·²ç§»é™¤ -->

<div class="container py-3">
    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡æŒ‰éˆ• -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <div class="flex-shrink-0">
            <h2 class="mb-1">ğŸ“ˆ æŠ•è³‡çœ‹æ¿</h2>
            <div class="status-bar">
                <span id="autoUpdateStatus">ç­‰å¾…ç™»å…¥...</span>
                <span class="firebase-status" id="firebaseStatus">é€£ç·šä¸­...</span>
            </div>
        </div>
        
        <div class="header-actions">
            <div class="user-section">
                <span id="userInfo" class="user-info d-none d-md-block">è«‹ç™»å…¥</span>
            </div>
            
            <div class="btn-group-actions">
                <button id="btnGoogleSignIn" class="btn btn-danger btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.636c0 1.64-.42 3.17-1.15 4.51a9.03 9.03 0 0 1-3.14 3.29 8.78 8.78 0 0 1-4.42 1.18A9 9 0 1 1 12 3.48a8.93 8.93 0 0 1 2.96 2.19l-3.02 2.9a5.37 5.37 0 0 0-3.94-1.69 5.52 5.52 0 1 0 3.94 9.4 4.48 4.48 0 0 0 2.93-2.96H8.03v-3.8h7.52z"/>
                    </svg>
                    <span class="ms-1">Google ç™»å…¥</span>
                </button>

                <button id="btnSignOut" class="btn btn-secondary btn-sm" style="display:none;">
                    ç™»å‡º
                </button>
                
                <button id="btnUpdatePrice" class="btn btn-primary btn-sm">
                    ğŸ”„ æ›´æ–°ç¾åƒ¹
                </button>
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="row g-2 mb-3">
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">ç¸½å¸‚å€¼</h5>
                <h3 id="totalMarketValue">$0</h3>
                <small class="text-muted">ç¾å€¼</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">ç¸½æˆæœ¬</h5>
                <h3 id="totalCost">$0</h3>
                <small class="text-muted">æœ¬é‡‘</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">æœªå¯¦ç¾</h5>
                <h3 id="totalUnrealizedPL">$0</h3>
                <small id="totalUnrealizedRate">0%</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">å·²å¯¦ç¾+è‚¡åˆ©</h5>
                <h3 id="totalRealizedPL">$0</h3>
                <small class="text-muted">ç²åˆ©</small>
            </div>
        </div>
    </div>

    <!-- æ–°å¢äº¤æ˜“è¡¨å–® -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            â• æ–°å¢äº¤æ˜“
        </div>
        <div class="card-body">
            <form id="tradeForm" class="row g-2">
                <div class="col-6 col-md-2">
                    <label class="form-label small">é¡åˆ¥</label>
                    <select class="form-select form-select-sm" id="type">
                        <option value="buy">è²·å…¥</option>
                        <option value="sell">è³£å‡º</option>
                        <option value="dividend">ç¾é‡‘è‚¡åˆ©</option>
                        <option value="discount">æŠ˜è®“/é€€è²»</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small">ä»£è™Ÿ</label>
                    <input type="text" class="form-control form-control-sm" id="symbol" placeholder="2330" required>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small">æ—¥æœŸ</label>
                    <input type="date" class="form-control form-control-sm" id="tradeDate" required>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small" id="lblQty">è‚¡æ•¸</label>
                    <input type="number" class="form-control form-control-sm" id="qty">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small" id="lblPrice">å–®åƒ¹</label>
                    <input type="number" class="form-control form-control-sm" id="price" step="0.01">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small" id="lblFee">æ‰‹çºŒè²»</label>
                    <input type="number" class="form-control form-control-sm" id="fee" readonly style="background-color: #f0f0f0;">
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success w-100">ç¢ºèªæ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æŒå€‰æ˜ç´° -->
    <div class="card">
        <div class="card-header">ğŸ“Š ç›®å‰æŒå€‰æ˜ç´°</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th>è‚¡ç¥¨</th>
                            <th>è‚¡æ•¸</th>
                            <th>å‡åƒ¹</th>
                            <th>ç¾åƒ¹</th>
                            <th>å¸‚å€¼</th>
                            <th>æœªå¯¦ç¾æç›Š</th>
                            <th>å ±é…¬ç‡ %</th>
                            <th>ç´¯è¨ˆè‚¡åˆ©</th>
                            <th>å«æ¯ç¸½ç›Š</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTable">
                        <tr><td colspan="9" class="text-center text-muted py-4">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥å€‹äººæŒå€‰æ•¸æ“š</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å¹³å€‰æ˜ç´° -->
    <div class="card">
        <div class="card-header">ğŸ’¸ å¹³å€‰æ˜ç´° (å·²å¯¦ç¾æç›Š)</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover align-middle mb-0 text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th>è‚¡ç¥¨</th>
                            <th>è‚¡æ•¸</th>
                            <th>ç¸½æˆæœ¬</th>
                            <th>ç¸½æ”¶å…¥</th>
                            <th>è³£å‡ºæç›Š</th>
                            <th>å ±é…¬ç‡ %</th>
                        </tr>
                    </thead>
                    <tbody id="closedPositionsTable">
                        <tr><td colspan="6" class="text-center text-muted py-3">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥å€‹äººæ•¸æ“š</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- æ­·å²ç´€éŒ„ -->
    <div class="card">
        <div class="card-header">ğŸ“ æ­·å²ç´€éŒ„</div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped mb-0 text-nowrap">
                    <thead class="sticky-top bg-white">
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é¡åˆ¥</th>
                            <th>è‚¡ç¥¨</th>
                            <th>æ˜ç´°</th>
                            <th>æç›Š/æ”¶æ”¯</th>
                            <th>è²»ç”¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr><td colspan="7" class="text-center text-muted py-3">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥æ­·å²æ•¸æ“š</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
(function() {
    'use strict';
    
    // Service Worker å·²æš«æ™‚ç§»é™¤ï¼Œé¿å…è·¯å¾‘å•é¡Œ
    // æ‰‹æ©Ÿä»å¯ä½¿ç”¨ã€ŒåŠ å…¥ä¸»ç•«é¢ã€åŠŸèƒ½
    
    const firebaseConfig = {
      apiKey: "AIzaSyDqE-QYqXgZ1xZ_oKIIGIypDzB4iKIvwCk",
      authDomain: "stock-dashboard-a1b1c.firebaseapp.com",
      databaseURL: "https://stock-dashboard-a1b1c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "stock-dashboard-a1b1c",
      storageBucket: "stock-dashboard-a1b1c.firebasestorage.app",
      messagingSenderId: "1013607091612",
      appId: "1:1013607091612:web:eb8c54458a3d731bf9cc59",
      measurementId: "G-WQ32XFZQSQ"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    let transactionsRef = null;
    let pricesRef = null;
    let transactions = [];
    let priceCache = {};
    let currentUID = null;
    let priceUpdateInterval = null;
    const PRICE_UPDATE_INTERVAL = 30000;

    database.ref('.info/connected').on('value', (snap) => {
        const statusEl = document.getElementById('firebaseStatus');
        if (snap.val() === true) {
            statusEl.innerText = 'å·²é€£ç·š âœ“';
            statusEl.className = 'firebase-status firebase-connected';
        } else {
            statusEl.innerText = 'é›¢ç·š âœ—';
            statusEl.className = 'firebase-status firebase-disconnected';
        }
    });

    document.getElementById('tradeDate').valueAsDate = new Date();

    const fmtMoney = (n) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits:0, maximumFractionDigits:0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('zh-TW').format(n);
    const fmtRound = (n) => Math.round(n);

    function calculateFee(amount) {
        let fee = Math.round(amount * 0.001425);
        return Math.max(fee, 20);
    }

    function updateFeeDisplay() {
        const type = document.getElementById('type').value;
        if (type === 'buy' || type === 'sell') {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const qty = parseFloat(document.getElementById('qty').value) || 0;
            const amount = price * qty;
            const fee = calculateFee(amount);
            document.getElementById('fee').value = fee;
        } else {
            document.getElementById('fee').value = 0;
        }
    }

    function toggleInputs() {
        const type = document.getElementById('type').value;
        const priceInput = document.getElementById('price');
        const qtyInput = document.getElementById('qty');
        const feeInput = document.getElementById('fee');
        const lblPrice = document.getElementById('lblPrice');
        const lblQty = document.getElementById('lblQty');
        const lblFee = document.getElementById('lblFee');
        const symbolInput = document.getElementById('symbol');

        if (type === 'dividend' || type === 'discount') {
            qtyInput.disabled = true;
            qtyInput.value = 1;
            symbolInput.disabled = type === 'discount';
            symbolInput.required = type !== 'discount';
            lblPrice.innerText = type === 'dividend' ? "ç¸½é‡‘é¡" : "é‡‘é¡";
            lblQty.innerText = "ä»½æ•¸(1)";
            priceInput.placeholder = "ç¸½é‡‘é¡";
            feeInput.value = 0;
            lblFee.innerText = "å…æ‰‹çºŒè²»";
            feeInput.disabled = true;
        } else {
            qtyInput.disabled = false;
            symbolInput.disabled = false;
            symbolInput.required = true;
            lblPrice.innerText = "æˆäº¤å–®åƒ¹";
            lblQty.innerText = "è‚¡æ•¸";
            priceInput.placeholder = "";
            lblFee.innerText = "æ‰‹çºŒè²»";
            feeInput.disabled = true;
            updateFeeDisplay();
        }
    }

    function cleanupFirebaseListeners() {
        if (transactionsRef) transactionsRef.off();
        if (pricesRef) pricesRef.off();
    }

    function loadDataFromFirebase() {
        if (!currentUID) {
            transactions = [];
            priceCache = {};
            render();
            return;
        }
        
        cleanupFirebaseListeners();
        
        transactionsRef = database.ref(`users/${currentUID}/transactions`);
        pricesRef = database.ref('prices');
        
        transactionsRef.on('value', (snapshot) => {
            transactions = [];
            snapshot.forEach((child) => {
                transactions.push({
                    id: child.key,
                    ...child.val()
                });
            });
            render();
        });

        pricesRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                priceCache = snapshot.val();
                render();
            }
        });
    }

    function calculateHoldingsAndClosed() {
        let holdings = {};
        let closedPositions = {};
        let totalRealized = 0;
        let totalDividends = 0;
        let symbolDividends = {};
        
        [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            if (!t.symbol && t.type !== 'discount') return;

            if (!holdings[t.symbol]) holdings[t.symbol] = { qty: 0, cost: 0 };
            if (!symbolDividends[t.symbol]) symbolDividends[t.symbol] = 0;
            
            let h = holdings[t.symbol];
            
            if (t.type === 'buy') {
                h.qty += t.qty;
                h.cost += (t.price * t.qty) + t.fee;
            } else if (t.type === 'sell') {
                let soldQty = t.qty;
                let avgCostForSale = h.qty > 0 ? h.cost / h.qty : t.price;
                let costPart = avgCostForSale * soldQty;
                let revenue = (t.price * soldQty) - t.fee;
                let profit = revenue - costPart;

                if (!closedPositions[t.symbol]) closedPositions[t.symbol] = { cost: 0, revenue: 0, qty: 0 };
                closedPositions[t.symbol].cost += costPart;
                closedPositions[t.symbol].revenue += revenue;
                closedPositions[t.symbol].qty += soldQty;

                h.qty -= soldQty;
                h.cost -= costPart;
                totalRealized += profit;

            } else if (t.type === 'dividend' || t.type === 'discount') {
                symbolDividends[t.symbol] += t.price;
                totalDividends += t.price;
            }
        });
        
        Object.keys(holdings).forEach(k => {
            if (holdings[k].qty < 0.001) delete holdings[k];
        });

        return { holdings, closedPositions, totalRealized, totalDividends, symbolDividends };
    }

    async function autoUpdatePrices() {
        if (!currentUID) {
            document.getElementById('autoUpdateStatus').innerText = 'è«‹ç™»å…¥ä»¥æ›´æ–°è‚¡åƒ¹';
            return;
        }

        const { holdings } = calculateHoldingsAndClosed();
        const symbols = Object.keys(holdings);

        if (symbols.length === 0) {
            document.getElementById('autoUpdateStatus').innerText = 'ç„¡æŒå€‰,ç„¡éœ€æ›´æ–°';
            return;
        }

        let query = symbols.map(s => `tse_${s}.tw|otc_${s}.tw`).join('|');
        const timeStamp = new Date().getTime();
        const targetUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${query}&json=1&delay=0&_=${timeStamp}`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;

        try {
            const res = await fetch(proxyUrl);
            const data = await res.json();

            if (data.msgArray && data.msgArray.length > 0) {
                let updates = {};
                data.msgArray.forEach(stk => {
                    let sym = stk.c;
                    let price = stk.z;
                    let source = "å³æ™‚";

                    if (price === '-' || !price) {
                        if (stk.o && stk.o !== '-') { price = stk.o; source = "é–‹ç›¤"; }
                        else if (stk.y && stk.y !== '-') { price = stk.y; source = "æ˜¨æ”¶"; }
                        else if (stk.b && stk.b.split('_')[0] !== '-') { price = stk.b.split('_')[0]; source = "è²·é€²"; }
                    }

                    if (sym && price && price !== '-') {
                        updates[sym] = { 
                            val: parseFloat(price), 
                            src: source, 
                            time: stk.t || '' 
                        };
                    }
                });

                pricesRef.update(updates);
                updateStatusMessage();
            }
        } catch (err) {
            console.error('æ›´æ–°å¤±æ•—:', err);
            document.getElementById('autoUpdateStatus').innerText = 'æ›´æ–°å¤±æ•—';
        }
    }

    function updateStatusMessage() {
        const status = document.getElementById('autoUpdateStatus');
        const now = new Date();
        const time = now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
        status.innerText = `æ›´æ–°: ${time}`;
    }

    window.manualPrice = function(sym, val) {
        if (!currentUID || !pricesRef) {
            alert('è«‹ç™»å…¥å¾Œå†é€²è¡Œæ‰‹å‹•åƒ¹æ ¼è¨­å®šã€‚');
            return;
        }
        pricesRef.child(sym).set({ val: parseFloat(val), src: "æ‰‹å‹•", time: "" });
    };

    window.deleteTrade = function(id) {
        if (!currentUID) {
            alert('è«‹å…ˆç™»å…¥ï¼');
            return;
        }
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            transactionsRef.child(id).remove();
        }
    };

    function render() {
        const { holdings, closedPositions, totalRealized, totalDividends, symbolDividends } = calculateHoldingsAndClosed();
        
        const tbodyHoldings = document.getElementById('holdingsTable');
        tbodyHoldings.innerHTML = '';
        
        let gMkt=0, gCost=0, gUnrealized=0;

        if (currentUID && Object.keys(holdings).length > 0) {
            for (let s in holdings) {
                let h = holdings[s];
                let avg = h.cost / h.qty;
                
                let pObj = priceCache[s] || { val: avg, src: 'ç„¡' };
                let currP = pObj.val;

                let mkt = h.qty * currP;
                let unrl = mkt - h.cost;
                let rate = h.cost ? (unrl/h.cost)*100 : 0;
                let divId = symbolDividends[s] || 0;
                let divPlusUnrl = divId + unrl;
                
                gMkt += mkt;
                gCost += h.cost;
                gUnrealized += unrl;

                let unrlCls = unrl >= 0 ? 'text-up' : 'text-down';
                let rateCls = rate >= 0 ? 'text-up' : 'text-down';
                let divCls = divId >= 0 ? 'text-up' : 'text-down';
                let divPlusCls = divPlusUnrl >= 0 ? 'text-up' : 'text-down';

                let tr = `
                    <tr>
                        <td><strong>${s}</strong></td>
                        <td>${fmtNum(h.qty)}</td>
                        <td>${fmtNum(avg.toFixed(2))}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm d-inline-block p-1" style="width:70px; font-size: 0.85rem;" 
                                value="${currP}" onchange="manualPrice('${s}', this.value)">
                            <span class="price-source">${pObj.src}</span>
                        </td>
                        <td>${fmtMoney(mkt)}</td>
                        <td class="${unrlCls}">${fmtMoney(fmtRound(unrl))}</td>
                        <td class="${rateCls}">${rate.toFixed(1)}%</td>
                        <td class="${divCls}">${fmtMoney(fmtRound(divId))}</td>
                        <td class="${divPlusCls}">${fmtMoney(fmtRound(divPlusUnrl))}</td>
                    </tr>`;
                tbodyHoldings.innerHTML += tr;
            }
        } else if (!currentUID) {
             tbodyHoldings.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥å€‹äººæŒå€‰æ•¸æ“š</td></tr>`;
        } else {
             tbodyHoldings.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">å°šç„¡æŒå€‰ç´€éŒ„</td></tr>`;
        }

        const tbodyClosed = document.getElementById('closedPositionsTable');
        tbodyClosed.innerHTML = '';
        
        if (currentUID && Object.keys(closedPositions).length > 0) {
            for (let s in closedPositions) {
                let cp = closedPositions[s];
                let profit = cp.revenue - cp.cost;
                let rate = cp.cost ? (profit/cp.cost)*100 : 0;

                if (cp.qty > 0) {
                     let profitCls = profit >= 0 ? 'text-up' : 'text-down';
                     let rateCls = rate >= 0 ? 'text-up' : 'text-down';

                     let tr = `
                         <tr>
                             <td><strong>${s}</strong></td>
                             <td>${fmtNum(cp.qty)}</td>
                             <td>${fmtMoney(fmtRound(cp.cost))}</td>
                             <td>${fmtMoney(fmtRound(cp.revenue))}</td>
                             <td class="${profitCls}">${fmtMoney(fmtRound(profit))}</td>
                             <td class="${rateCls}">${rate.toFixed(1)}%</td>
                         </tr>`;
                     tbodyClosed.innerHTML += tr;
                }
            }
        } else if (!currentUID) {
             tbodyClosed.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥å€‹äººæ•¸æ“š</td></tr>`;
        } else {
             tbodyClosed.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">å°šç„¡å¹³å€‰ç´€éŒ„</td></tr>`;
        }

        document.getElementById('totalMarketValue').innerText = fmtMoney(fmtRound(gMkt));
        document.getElementById('totalMarketValue').className = gMkt >= 0 ? 'text-up' : 'text-down';
        
        document.getElementById('totalCost').innerText = fmtMoney(fmtRound(gCost));
        document.getElementById('totalCost').className = gCost >= 0 ? 'text-up' : 'text-down';

        document.getElementById('totalUnrealizedPL').innerText = fmtMoney(fmtRound(gUnrealized));
        document.getElementById('totalUnrealizedPL').className = gUnrealized >= 0 ? 'text-up' : 'text-down';
        document.getElementById('totalUnrealizedRate').innerText = (gCost ? (gUnrealized/gCost)*100 : 0).toFixed(2) + '%';
        
        document.getElementById('totalRealizedPL').innerText = fmtMoney(fmtRound(totalRealized + totalDividends));
        document.getElementById('totalRealizedPL').className = (totalRealized + totalDividends) >= 0 ? 'text-up' : 'text-down';

        const hBody = document.getElementById('historyTable');
        hBody.innerHTML = '';
        if (currentUID && transactions.length > 0) {
            [...transactions].reverse().forEach(t => {
                let typeText = t.type === 'buy' ? 'è²·' : (t.type === 'sell' ? 'è³£' : (t.type === 'dividend' ? 'æ¯' : 'æŠ˜'));
                let typeBg = t.type === 'buy' ? 'bg-danger' : (t.type === 'sell' ? 'bg-success' : 'bg-warning text-dark');
                let detail = (t.type === 'dividend' || t.type === 'discount') ? fmtMoney(fmtRound(t.price)) : `${fmtNum(t.price)} Ã— ${fmtNum(t.qty)}`;
                let amount = t.type === 'buy' ? (t.price * t.qty + t.fee) : (t.type === 'sell' ? (t.price * t.qty - t.fee) : t.price);
                
                let tr = `<tr>
                    <td><small>${t.date.substring(5)}</small></td>
                    <td><span class="badge ${typeBg}">${typeText}</span></td>
                    <td>${t.symbol || '-'}</td>
                    <td><small>${detail}</small></td>
                    <td>${t.type === 'buy' ? '-' : '+'}${fmtMoney(fmtRound(Math.abs(amount)))}</td>
                    <td><small>${t.fee > 0 ? t.fee : '-'}</small></td>
                    <td><button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="deleteTrade('${t.id}')">Ã—</button></td>
                 </tr>`;
                hBody.innerHTML += tr;
            });
        } else if (!currentUID) {
             hBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥æ­·å²æ•¸æ“š</td></tr>`;
        } else {
             hBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">å°šç„¡äº¤æ˜“ç´€éŒ„</td></tr>`;
        }
    }

    document.getElementById('price').addEventListener('change', updateFeeDisplay);
    document.getElementById('price').addEventListener('keyup', updateFeeDisplay);
    document.getElementById('qty').addEventListener('change', updateFeeDisplay);
    document.getElementById('qty').addEventListener('keyup', updateFeeDisplay);
    document.getElementById('type').addEventListener('change', function() {
        toggleInputs();
        updateFeeDisplay();
    });

    document.getElementById('tradeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentUID) {
            alert('è«‹å…ˆä½¿ç”¨ Google ç™»å…¥æ‰èƒ½æ–°å¢äº¤æ˜“ç´€éŒ„ï¼');
            return;
        }

        const type = document.getElementById('type').value;
        const symbol = document.getElementById('symbol').value.toUpperCase().trim();
        const tradeDate = document.getElementById('tradeDate').value;
        let price = parseFloat(document.getElementById('price').value) || 0;
        let qty = parseFloat(document.getElementById('qty').value) || 0;
        let fee = parseFloat(document.getElementById('fee').value) || 0;

        if (!tradeDate || !price) {
            alert('è«‹å¡«å…¥äº¤æ˜“æ—¥æœŸå’Œé‡‘é¡');
            return;
        }

        if ((type === 'buy' || type === 'sell') && !symbol) {
            alert('è«‹å¡«å…¥è‚¡ç¥¨ä»£è™Ÿ');
            return;
        }

        const newTransaction = { 
            date: tradeDate,
            time: new Date().toISOString(),
            type, 
            symbol, 
            price, 
            qty, 
            fee 
        };

        transactionsRef.push(newTransaction);
        
        this.reset();
        document.getElementById('type').value = 'buy';
        document.getElementById('tradeDate').valueAsDate = new Date();
        toggleInputs();
    });

    document.getElementById('btnGoogleSignIn').addEventListener('click', function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .catch((error) => {
                console.error("Google Sign-In Error: ", error);
                alert("Google ç™»å…¥å¤±æ•—: " + error.message);
            });
    });

    document.getElementById('btnSignOut').addEventListener('click', function() {
        if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
            auth.signOut();
        }
    });

    document.getElementById('btnUpdatePrice').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ æ›´æ–°ä¸­...';
        btn.classList.add('loading');

        autoUpdatePrices().then(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('loading');
        });
    });

    auth.onAuthStateChanged((user) => {
        const userInfoEl = document.getElementById('userInfo');
        const signInBtn = document.getElementById('btnGoogleSignIn');
        const signOutBtn = document.getElementById('btnSignOut');
        
        if (user) {
            currentUID = user.uid;
            const displayName = user.displayName || user.email;
            userInfoEl.innerText = `æ­¡è¿, ${displayName.split(' ')[0]}`;
            signInBtn.style.display = 'none';
            signOutBtn.style.display = 'block';
            
            loadDataFromFirebase(); 
            
            if (priceUpdateInterval) clearInterval(priceUpdateInterval);
            autoUpdatePrices();
            priceUpdateInterval = setInterval(autoUpdatePrices, PRICE_UPDATE_INTERVAL);

        } else {
            currentUID = null;
            userInfoEl.innerText = 'è«‹ç™»å…¥';
            signInBtn.style.display = 'block';
            signOutBtn.style.display = 'none';
            
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
            
            cleanupFirebaseListeners();
            transactions = [];
            priceCache = {};
            render();
            
            document.getElementById('autoUpdateStatus').innerText = 'ç­‰å¾…ç™»å…¥...';
        }
    });

    toggleInputs();
})();
</script>

</body>
</html>
