<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>å€‹äººè‚¡ç¥¨æç›Šç®¡ç† (é›²ç«¯ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none; margin-bottom: 1.5rem; }
        .stat-card { text-align: center; padding: 15px; height: 100%; }
        
        /* æ–‡å­—é¡è‰²èˆ‡æ¨£å¼ */
        .text-up { color: #dc3545 !important; font-weight: bold !important; }
        .text-down { color: #198754 !important; font-weight: bold !important; }
        .price-source { font-size: 0.7rem; color: #999; display: block; margin-top: 2px;}
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-bar { font-size: 0.8rem; color: #6c757d; margin-top: 5px; }
        .firebase-status { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;}
        .firebase-connected { background-color: #d1e7dd; color: #0f5132; }
        .firebase-disconnected { background-color: #f8d7da; color: #842029; }
        
        /* æŒ‰éˆ•è®€å–å‹•ç•« */
        .loading { opacity: 0.7; pointer-events: none; }

        /* æ‰‹æ©Ÿç‰ˆå­—é«”å„ªåŒ– */
        @media (max-width: 576px) {
            h2 { font-size: 1.5rem; }
            .stat-card h3 { font-size: 1.5rem; }
            .stat-card h5 { font-size: 0.9rem; }
            .btn { width: 100%; margin-top: 5px; } /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•æ»¿å¯¬ */
            .header-controls { flex-direction: column; align-items: flex-start; }
            .header-controls > div { width: 100%; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div class="container py-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <div class="mb-2">
            <h2 class="mb-1">ğŸ“ˆ æŠ•è³‡çœ‹æ¿ <small class="text-muted fs-6">(é›²ç«¯ç‰ˆ)</small></h2>
            <div class="status-bar">
                <span id="autoUpdateStatus">æ›´æ–°ä¸­...</span> | 
                <span class="firebase-status" id="firebaseStatus">é€£ç·šä¸­...</span>
            </div>
        </div>
        <div class="col-12 col-md-auto">
            <button id="btnUpdatePrice" class="btn btn-primary btn-sm px-3" onclick="forceUpdatePrices()">
                ğŸ”„ å¼·åˆ¶æ›´æ–°ç¾åƒ¹
            </button>
        </div>
    </div>

    <div class="row g-2 mb-4">
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">ç¸½å¸‚å€¼</h5>
                <h3 id="totalMarketValue">0</h3>
                <small class="text-muted">ç¾å€¼</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">ç¸½æˆæœ¬</h5>
                <h3 id="totalCost">0</h3>
                <small class="text-muted">æœ¬é‡‘</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">æœªå¯¦ç¾</h5>
                <h3 id="totalUnrealizedPL">0</h3>
                <small id="totalUnrealizedRate">0%</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card">
                <h5 class="text-muted">å·²å¯¦ç¾+è‚¡åˆ©</h5>
                <h3 id="totalRealizedPL">0</h3>
                <small class="text-muted">ç²åˆ©</small>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span>â• æ–°å¢äº¤æ˜“</span>
            <small>è«‹å¡«å¯«ä¸‹æ–¹è³‡è¨Š</small>
        </div>
        <div class="card-body">
            <form id="tradeForm" class="row g-2">
                <div class="col-6 col-md-2">
                    <label class="form-label small">é¡åˆ¥</label>
                    <select class="form-select form-select-sm" id="type" onchange="toggleInputs()">
                        <option value="buy">è²·å…¥</option>
                        <option value="sell">è³£å‡º</option>
                        <option value="dividend">ç¾é‡‘è‚¡åˆ©</option>
                        <option value="discount">æŠ˜è®“/é€€è²»</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small">ä»£è™Ÿ</label>
                    <input type="text" class="form-control form-control-sm" id="symbol" placeholder="2330" required>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small">æ—¥æœŸ</label>
                    <input type="date" class="form-control form-control-sm" id="tradeDate" required>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small" id="lblQty">è‚¡æ•¸</label>
                    <input type="number" class="form-control form-control-sm" id="qty">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small" id="lblPrice">å–®åƒ¹</label>
                    <input type="number" class="form-control form-control-sm" id="price" step="0.01">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label small" id="lblFee">æ‰‹çºŒè²»</label>
                    <input type="number" class="form-control form-control-sm" id="fee" readonly style="background-color: #f0f0f0;">
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success w-100">ç¢ºèªæ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“Š ç›®å‰æŒå€‰æ˜ç´°</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th>è‚¡ç¥¨</th>
                            <th>è‚¡æ•¸</th>
                            <th>å‡åƒ¹</th>
                            <th>ç¾åƒ¹(æ‰‹å‹•)</th>
                            <th>å¸‚å€¼</th>
                            <th>æœªå¯¦ç¾æç›Š</th>
                            <th>å ±é…¬ç‡ %</th>
                            <th>ç´¯è¨ˆè‚¡åˆ©</th>
                            <th>å«æ¯ç¸½ç›Š</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“ æ­·å²ç´€éŒ„</div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped mb-0 text-nowrap">
                    <thead class="sticky-top bg-white">
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é¡åˆ¥</th>
                            <th>è‚¡ç¥¨</th>
                            <th>æ˜ç´°</th>
                            <th>æç›Š/æ”¶æ”¯</th>
                            <th>è²»ç”¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
    // âš ï¸ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDqE-QYqXgZ1xZ_oKIIGIypDzB4iKIvwCk",
      authDomain: "stock-dashboard-a1b1c.firebaseapp.com",
      databaseURL: "https://stock-dashboard-a1b1c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "stock-dashboard-a1b1c",
      storageBucket: "stock-dashboard-a1b1c.firebasestorage.app",
      messagingSenderId: "1013607091612",
      appId: "1:1013607091612:web:eb8c54458a3d731bf9cc59",
      measurementId: "G-WQ32XFZQSQ"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const transactionsRef = database.ref('transactions');
    const pricesRef = database.ref('prices');

    let transactions = [];
    let priceCache = {};
    const PRICE_UPDATE_INTERVAL = 30000;

    // ç›£è½ Firebase é€£ç·šç‹€æ…‹
    const connectedRef = database.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        const statusEl = document.getElementById('firebaseStatus');
        if (snap.val() === true) {
            statusEl.innerText = 'å·²é€£ç·š âœ“';
            statusEl.className = 'firebase-status firebase-connected';
        } else {
            statusEl.innerText = 'é›¢ç·š âœ—';
            statusEl.className = 'firebase-status firebase-disconnected';
        }
    });

    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('tradeDate').valueAsDate = new Date();

    // æ ¼å¼åŒ–å‡½æ•¸
    const fmtMoney = (n) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits:0, maximumFractionDigits:0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('zh-TW').format(n);
    const fmtRound = (n) => Math.round(n);

    // è¨ˆç®—æ‰‹çºŒè²»
    function calculateFee(amount) {
        let fee = Math.round(amount * 0.001425);
        return Math.max(fee, 20);
    }

    // ç›£è½åƒ¹æ ¼å’Œè‚¡æ•¸è®ŠåŒ–
    document.getElementById('price').addEventListener('change', updateFeeDisplay);
    document.getElementById('price').addEventListener('keyup', updateFeeDisplay);
    document.getElementById('qty').addEventListener('change', updateFeeDisplay);
    document.getElementById('qty').addEventListener('keyup', updateFeeDisplay);
    document.getElementById('type').addEventListener('change', updateFeeDisplay);

    function updateFeeDisplay() {
        const type = document.getElementById('type').value;
        if (type === 'buy' || type === 'sell') {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const qty = parseFloat(document.getElementById('qty').value) || 0;
            const amount = price * qty;
            const fee = calculateFee(amount);
            document.getElementById('fee').value = fee;
        } else {
            document.getElementById('fee').value = 0;
        }
    }

    function toggleInputs() {
        const type = document.getElementById('type').value;
        const priceInput = document.getElementById('price');
        const qtyInput = document.getElementById('qty');
        const feeInput = document.getElementById('fee');
        const lblPrice = document.getElementById('lblPrice');
        const lblQty = document.getElementById('lblQty');
        const lblFee = document.getElementById('lblFee');
        const symbolInput = document.getElementById('symbol');

        if (type === 'dividend' || type === 'discount') {
            qtyInput.disabled = true;
            qtyInput.value = 1;
            symbolInput.disabled = type === 'discount';
            symbolInput.required = type !== 'discount';
            lblPrice.innerText = type === 'dividend' ? "ç¸½é‡‘é¡" : "é‡‘é¡";
            lblQty.innerText = "ä»½æ•¸(1)";
            priceInput.placeholder = "ç¸½é‡‘é¡";
            feeInput.value = 0;
            lblFee.innerText = "å…æ‰‹çºŒè²»";
            feeInput.disabled = true;
        } else {
            qtyInput.disabled = false;
            symbolInput.disabled = false;
            symbolInput.required = true;
            lblPrice.innerText = "æˆäº¤å–®åƒ¹";
            lblQty.innerText = "è‚¡æ•¸";
            priceInput.placeholder = "";
            lblFee.innerText = "æ‰‹çºŒè²»";
            feeInput.disabled = true;
            updateFeeDisplay();
        }
    }

    document.getElementById('tradeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.getElementById('type').value;
        const symbol = document.getElementById('symbol').value.toUpperCase().trim();
        const tradeDate = document.getElementById('tradeDate').value;
        let price = parseFloat(document.getElementById('price').value) || 0;
        let qty = parseFloat(document.getElementById('qty').value) || 0;
        let fee = parseFloat(document.getElementById('fee').value) || 0;

        if (!tradeDate || !price) {
            alert('è«‹å¡«å…¥äº¤æ˜“æ—¥æœŸå’Œé‡‘é¡');
            return;
        }

        if ((type === 'buy' || type === 'sell') && !symbol) {
            alert('è«‹å¡«å…¥è‚¡ç¥¨ä»£è™Ÿ');
            return;
        }

        const newTransaction = { 
            date: tradeDate,
            time: new Date().toISOString(),
            type, 
            symbol, 
            price, 
            qty, 
            fee 
        };

        // æ–°å¢åˆ° Firebase
        transactionsRef.push(newTransaction);
        
        this.reset();
        document.getElementById('type').value = 'buy';
        document.getElementById('tradeDate').valueAsDate = new Date();
        toggleInputs();
    });

    function deleteTrade(id) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            transactionsRef.child(id).remove();
        }
    }

    // å¾ Firebase è¼‰å…¥è³‡æ–™
    function loadDataFromFirebase() {
        transactionsRef.on('value', (snapshot) => {
            transactions = [];
            snapshot.forEach((child) => {
                transactions.push({
                    id: child.key,
                    ...child.val()
                });
            });
            render();
        });

        pricesRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                priceCache = snapshot.val();
                render();
            }
        });
    }

    function calculateHoldings() {
        let holdings = {};
        let totalRealized = 0;
        let totalDividends = 0;
        let symbolDividends = {};
        
        [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            if (!holdings[t.symbol]) holdings[t.symbol] = { qty: 0, cost: 0 };
            if (!symbolDividends[t.symbol]) symbolDividends[t.symbol] = 0;
            
            let h = holdings[t.symbol];
            
            if (t.type === 'buy') {
                h.qty += t.qty;
                h.cost += (t.price * t.qty) + t.fee;
            } else if (t.type === 'sell') {
                let avg = h.qty > 0 ? h.cost / h.qty : t.price;
                let costPart = avg * t.qty;
                let rev = (t.price * t.qty) - t.fee;
                h.qty -= t.qty;
                h.cost -= costPart;
                totalRealized += (rev - costPart);
            } else if (t.type === 'dividend') {
                symbolDividends[t.symbol] += t.price;
                totalDividends += t.price;
            } else if (t.type === 'discount') {
                symbolDividends[t.symbol] += t.price;
                totalDividends += t.price;
            }
        });
        
        Object.keys(holdings).forEach(k => {
            if (holdings[k].qty < 0.001) delete holdings[k];
        });

        return { holdings, totalRealized, totalDividends, symbolDividends };
    }

    async function autoUpdatePrices() {
        const { holdings } = calculateHoldings();
        const symbols = Object.keys(holdings);

        if (symbols.length === 0) return;

        let query = symbols.map(s => `tse_${s}.tw|otc_${s}.tw`).join('|');
        const timeStamp = new Date().getTime();
        const targetUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${query}&json=1&delay=0&_=${timeStamp}`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;

        try {
            const res = await fetch(proxyUrl);
            const data = await res.json();

            if (data.msgArray && data.msgArray.length > 0) {
                let updates = {};
                data.msgArray.forEach(stk => {
                    let sym = stk.c;
                    let price = stk.z;
                    let source = "å³æ™‚";

                    if (price === '-' || !price) {
                        if (stk.o && stk.o !== '-') { price = stk.o; source = "é–‹ç›¤"; }
                        else if (stk.y && stk.y !== '-') { price = stk.y; source = "æ˜¨æ”¶"; }
                        else if (stk.b && stk.b.split('_')[0] !== '-') { price = stk.b.split('_')[0]; source = "è²·é€²"; }
                    }

                    if (sym && price && price !== '-') {
                        updates[sym] = { 
                            val: parseFloat(price), 
                            src: source, 
                            time: stk.t || '' 
                        };
                    }
                });

                pricesRef.update(updates);
                updateStatusMessage();
            }
        } catch (err) {
            console.error('æ›´æ–°å¤±æ•—:', err);
        }
    }

    function forceUpdatePrices() {
        const btn = document.getElementById('btnUpdatePrice');
        btn.innerHTML = 'â³...';
        btn.classList.add('loading');

        autoUpdatePrices().then(() => {
            btn.innerHTML = 'ğŸ”„ å¼·åˆ¶æ›´æ–°ç¾åƒ¹';
            btn.classList.remove('loading');
        });
    }

    function updateStatusMessage() {
        const status = document.getElementById('autoUpdateStatus');
        const now = new Date();
        const time = now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        status.innerText = `æ›´æ–°: ${time}`;
    }

    function manualPrice(sym, val) {
        pricesRef.child(sym).set({ val: parseFloat(val), src: "æ‰‹å‹•", time: "" });
    }

    function render() {
        const { holdings, totalRealized, totalDividends, symbolDividends } = calculateHoldings();
        const tbody = document.getElementById('holdingsTable');
        tbody.innerHTML = '';
        
        let gMkt=0, gCost=0, gUnrealized=0;

        for (let s in holdings) {
            let h = holdings[s];
            let avg = h.cost / h.qty;
            
            let pObj = priceCache[s] || { val: avg, src: 'ç„¡' };
            let currP = pObj.val;

            let mkt = h.qty * currP;
            let unrl = mkt - h.cost;
            let rate = h.cost ? (unrl/h.cost)*100 : 0;
            let divId = symbolDividends[s] || 0;
            let divPlusUnrl = divId + unrl;
            
            gMkt += mkt;
            gCost += h.cost;
            gUnrealized += unrl;

            let unrlCls = unrl >= 0 ? 'text-up' : 'text-down';
            let rateCls = rate >= 0 ? 'text-up' : 'text-down';
            let divCls = divId >= 0 ? 'text-up' : 'text-down';
            let divPlusCls = divPlusUnrl >= 0 ? 'text-up' : 'text-down';

            let tr = `
                <tr>
                    <td><strong>${s}</strong></td>
                    <td>${fmtNum(h.qty)}</td>
                    <td>${fmtNum(avg.toFixed(2))}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm d-inline-block p-1" style="width:70px; font-size: 0.85rem;" 
                            value="${currP}" onchange="manualPrice('${s}', this.value)">
                        <span class="price-source">${pObj.src}</span>
                    </td>
                    <td>${fmtMoney(mkt)}</td>
                    <td class="${unrlCls}">${fmtMoney(fmtRound(unrl))}</td>
                    <td class="${rateCls}">${rate.toFixed(1)}%</td>
                    <td class="${divCls}">${fmtMoney(fmtRound(divId))}</td>
                    <td class="${divPlusCls}">${fmtMoney(fmtRound(divPlusUnrl))}</td>
                </tr>`;
            tbody.innerHTML += tr;
        }

        const hBody = document.getElementById('historyTable');
        hBody.innerHTML = '';
        [...transactions].reverse().forEach(t => {
            let typeText = t.type === 'buy' ? 'è²·' : (t.type === 'sell' ? 'è³£' : (t.type === 'dividend' ? 'æ¯' : 'æŠ˜'));
            let typeBg = t.type === 'buy' ? 'bg-danger' : (t.type === 'sell' ? 'bg-success' : 'bg-warning text-dark');
            let detail = (t.type === 'dividend' || t.type === 'discount') ? fmtMoney(fmtRound(t.price)) : `${fmtNum(t.price)} Ã— ${fmtNum(t.qty)}`;
            let amount = t.type === 'buy' ? (t.price * t.qty + t.fee) : (t.type === 'sell' ? (t.price * t.qty - t.fee) : t.price);
            
            let tr = `<tr>
                <td><small>${t.date.substring(5)}</small></td>
                <td><span class="badge ${typeBg}">${typeText}</span></td>
                <td>${t.symbol}</td>
                <td><small>${detail}</small></td>
                <td>${t.type === 'buy' ? '-' : '+'}${fmtMoney(fmtRound(Math.abs(amount)))}</td>
                <td><small>${t.fee > 0 ? t.fee : '-'}</small></td>
                <td><button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="deleteTrade('${t.id}')">Ã—</button></td>
             </tr>`;
            hBody.innerHTML += tr;
        });

        document.getElementById('totalMarketValue').innerText = fmtMoney(fmtRound(gMkt));
        document.getElementById('totalMarketValue').className = gMkt >= 0 ? 'text-up' : 'text-down';
        
        // ä¿®æ­£é€™è£¡ï¼šå¢åŠ ç¸½æˆæœ¬çš„é¡è‰²åˆ¤æ–·
        document.getElementById('totalCost').innerText = fmtMoney(fmtRound(gCost));
        document.getElementById('totalCost').className = gCost >= 0 ? 'text-up' : 'text-down';

        document.getElementById('totalUnrealizedPL').innerText = fmtMoney(fmtRound(gUnrealized));
        document.getElementById('totalUnrealizedPL').className = gUnrealized >= 0 ? 'text-up' : 'text-down';
        document.getElementById('totalUnrealizedRate').innerText = (gCost ? (gUnrealized/gCost)*100 : 0).toFixed(2) + '%';
        document.getElementById('totalRealizedPL').innerText = fmtMoney(fmtRound(totalRealized + totalDividends));
        document.getElementById('totalRealizedPL').className = (totalRealized + totalDividends) >= 0 ? 'text-up' : 'text-down';
    }

    // åˆå§‹åŒ–
    loadDataFromFirebase();
    autoUpdatePrices();
    updateStatusMessage();
    setInterval(autoUpdatePrices, PRICE_UPDATE_INTERVAL);
</script>

</body>
</html>
